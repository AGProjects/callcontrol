Installation
------------

For Debian testing or unstable on an i386 architecture there is an official
public repository provided by AG Projects. Install the AG Projects debian
software signing key:

wget http://download.ag-projects.com/agp-debian-gpg.key apt-key add
agp-debian-gpg.key

Add these lines in etc/apt/sources.list

# AG Projects software
deb http://ag-projects.com/debian unstable main
deb-src http://ag-projects.com/debian unstable main

After that, run:

apt-get update
apt-get install callcontrol


For non Debian installations, you must install the following dependencies:

python-application (>= 1.0.9)
python-twisted-core
python-sqlobject

You may run the software from its own directory or install it in a directory
anywhere in the system.


Configuration
-------------

You must setup the following components:

1. OpenSIPS configuration
2. Call Control configuration (this application)
3. CDRTool rating engine


1. OpenSIPS configuration

Sample configuration file:

loadmodule "call_control.so"
modparam("call_control", "disable",      0)
...

route {

   # call_control() function needs to be called only once during the first INVITE

   if ((method=="INVITE" && !has_totag())) {
        call_control();
        switch ($retcode) {
        case 2:
            # Call with no limit
        case 1:
            # Call with a limit under callcontrol management (either prepaid or postpaid)
            break;
        case -1:
            # Not enough credit (prepaid call)
            xlog("L_INFO", "Call control: not enough credit for prepaid call\n");
            acc_rad_request("402");
            if (0 && 1 && !isflagset(6)) {
                rewriteuri("sip:800301@vm.sipthor.net");
                resetflag(1);
                t_on_failure("6");
            } else {
                sl_send_reply("402", "Not enough credit");
                exit;
            }
            break;
        case -2:
            # Locked by call in progress (prepaid call)
            xlog("L_INFO", "Call control: prepaid call locked by another call in progress\n");
            acc_rad_request("403");
            if (0 && 1 && !isflagset(6)) {
                rewriteuri("sip:800302@vm.sipthor.net");
                resetflag(1);
                t_on_failure("6");
            } else {
                sl_send_reply("403", "Call locked by another call in progress");
                exit;
            }
            break;
        case -3:
            # No provider (prepaid call)
            xlog("L_INFO", "Call control: cannot find prepaid engine for domain $avp(billing_party_domain)\n");
        default:
            # Internal error (message parsing, communication, ...)
            if (isflagset(17)) {
                xlog("L_INFO", "Call control: internal server error\n");
                acc_rad_request("500");
                if (0 && 1 && !isflagset(6)) {
                    rewriteuri("sip:800399@vm.sipthor.net");
                    resetflag(1);
                    t_on_failure("6");
                } else {
                    sl_send_reply("500", "Internal server error");
                    exit;
                }
            } else {
                xlog("L_WARN", "Call control: cannot set time limit for postpaid call\n");
            }
        }
    }


    ....
}


2. Call Control configuration (this application)

The application is searching for its configuration file config.ini in its current
directory and in /etc/callcontrol/config.ini

A sample configuration file is available in config.ini.sample.


3. CDRTool rating engine

See the documentation that comes together with CDRTool.


Logging
-------

Call Control logs all activity to syslog. You may grep for call-control in
syslog. The requests can be correlated with the syslog entries generated by
CDRTool rating engine.

